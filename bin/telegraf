#!/usr/bin/env node

const util = require('util');
const Telegraf = require('telegraf');
const PurchaseSaver = require('../src/PurchaseSaver.js');
const MongoConnector = require('../src/MongoConnector.js');

const token = process.env.TELEGRAM_TOKEN;
const name = process.env.TELEGRAM_NAME;
// Reply via webhook
const bot = new Telegraf(token, {username: name, webhookReply: true});

// Http webhook, for nginx/heroku users.
// https://telegraf.js.org/#/?id=webhooks
// TODO Express.js example integration !
const port = process.env.PORT;
bot.startWebhook(`/bot${token}`, null, port);

const saver = new PurchaseSaver();
const connector = new MongoConnector();
bot.hears(/^(\d+.+)/i, (ctx) => {
    const message = ctx.match[1];
    try {
        saver.setInput(message).save(connector, (result) => {
            let debug = util.inspect(result, {showHidden: false, depth: null});
            console.log(debug);
            ctx.reply(debug);
        });
    } catch (e) {
        let debug = util.inspect(e, {showHidden: false, depth: null});
        ctx.reply(debug);
    }
});