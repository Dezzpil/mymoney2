#!/usr/bin/env node

const util = require('util');
const Telegraf = require('telegraf');
const PurchaseSaver = require('../src/PurchaseSaver.js');
const MongoConnectorFn = require('../src/MongoConnectorFn.js');

const token = process.env.TELEGRAM_TOKEN;
const options = {
    username: process.env.TELEGRAM_NAME,
    webhookReply: true
};
const bot = new Telegraf(token, options);

// Http webhook, for nginx/heroku users.
// https://telegraf.js.org/#/?id=webhooks
// TODO Express.js example integration !

const port = process.env.PORT; // use Heroku default
bot.startWebhook(`/bot${token}`, null, port);

const saver = new PurchaseSaver();
const connector = new MongoConnectorFn();
bot.hears(/^(\d+.+)/i, (ctx) => {
    const message = ctx.match[1];
    try {
        saver.setInput(message).saveFn(connector, (err, result) => {
            if (err) {
                console.error(err);
            } else {
                let debug = util.inspect(result, {showHidden: false, depth: null});
                console.log(debug);
                ctx.reply(debug);
            }
            connector.close();
        });
    } catch (e) {
        let debug = util.inspect(e, {showHidden: false, depth: null});
        ctx.reply(debug);
    }
});