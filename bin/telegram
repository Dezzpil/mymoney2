#!/usr/bin/env node

/**
 * This example demonstrates setting up webhook
 * on the Heroku platform.
 * @link https://github.com/yagop/node-telegram-bot-api/blob/master/examples/webhook/heroku.js
 */
const TelegramBot = require('node-telegram-bot-api');
const token = process.env.TELEGRAM_TOKEN;

const options = {
    webHook: {
        // Port to which you should bind is assigned to $PORT variable
        // See: https://devcenter.heroku.com/articles/dynos#local-environment-variables
        port: process.env.PORT
        // you do NOT need to set up certificates since Heroku provides
        // the SSL certs already (https://<app-name>.herokuapp.com)
        // Also no need to pass IP because on Heroku you need to bind to 0.0.0.0
    }
};

// Heroku routes from port :443 to $PORT
// Add URL of your app to env variable or enable Dyno Metadata
// to get this automatically
// See: https://devcenter.heroku.com/articles/dyno-metadata
const appName = process.env.HEROKU_APP_NAME;
const url = 'https://' + appName + '.herokuapp.com:443';
const bot = new TelegramBot(token, options);

// This informs the Telegram servers of the new webhook.
// Note: we do not need to pass in the cert, as it already provided
bot.setWebHook(`${url}/bot${token}`);

// Just to ping!
// bot.on('message', function onMessage(msg) {
//     bot.sendMessage(msg.chat.id, 'I am alive on Heroku!');
// });

const InputParser = require('../src/InputParser.js');
const MongoConnector = require('../src/MongoConnector.js');

const parser = new InputParser();
const connector = new MongoConnector();

bot.onText(/^(\d+.+)/, (msg, match) => {

    // parse and save info
    const chatId = msg.chat.id;
    const resp = match[1]; // the captured "whatever"

    try {
        // TODO DRY routes/base.js
        let parsed = parser.parse(resp);

        let rightNow = new Date();
        let now = rightNow.toISOString().slice(0,10).replace(/-/g,"/");
        let result = Object.assign(parsed, {made_at: now});

        // save result object to mongo
        (async function() {
            try {
                let db = await connector.connect();
                let col = db.collection('purchases');
                let r = await col.insertOne(result);
                bot.sendMessage(chatId, 'a1' + r.ops._id);
            } catch (e) {
                bot.sendMessage(chatId, 'a2' + e.toString())
            }
        })();
    } catch (e) {
        bot.sendMessage(chatId, 'a3' + e.toString())
    }
});