#!/usr/bin/env node
const util = require('util');
const Telegraf = require('telegraf');

const Parser = require('../src/Parser');
const Mongo = require('../src/Storage/Mongo');
const GoogleSheet = require('../src/Storage/GoogleSheet');
const Saver = require('../src/Saver.js');

const token = process.env.TELEGRAM_TOKEN;
const bot = new Telegraf(token, {
    username: process.env.TELEGRAM_NAME,
    webhookReply: true
});

// Http webhook, for nginx/heroku users.
// https://telegraf.js.org/#/?id=webhooks
bot.startWebhook(`/bot${token}`, null, process.env.PORT);

const parser = new Parser();
const saver = new Saver(parser);

bot.hears(/^(\d+.+)/i, async (ctx) => {

    const message = ctx.match[1];
    const user = ctx.from.username
        || ctx.from.first_name + ' ' + ctx.from.last_name;


    try {
        saver.setInput(message);
        saver.setUser(user);
    } catch (e) {
        let debug = util.inspect(e, {showHidden: false, depth: null});
        ctx.reply(debug);
    }

    try {
        await saver.save([new Mongo()]);

        const humanDate = new Date().toISOString().
            replace(/T/, ' ').      // replace T with a space
            replace(/\..+/, '')     // delete the dot and everything after
            ;
        saver.setDate(humanDate);
        await saver.save([new GoogleSheet()]);

        ctx.reply(`Сохранено: ${saver.getResults()}`);
    } catch (err) {
        ctx.reply(`Не удалось сохранить: ${util.inspect(saver.getErrors())}`);
    }

    // Бот отвечает в 2 сообщения: ОК, а потом _id записи
    // Если убрать этот ответ, то и _id не придет чат
    // Возможно из-за того, что соединение рвется, я хз
    ctx.reply('OK');
});

// bot.hears(/^за (.+?)\W/i, async (ctx) => {
//
//     const period = ctx.match[1];
//     const periodMap = {
//         'сегодня': 'today',
//         'день': '1d',
//         'неделю': '1w',
//         'месяц': '1m'
//     };
//
//     let msg = `Период ${period} не задан в программе`;
//     if (period in periodMap) {
//          msg = await Mongo.sum(periodMap[period]);
//     }
//
//     ctx.reply(msg);
// });
