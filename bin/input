#!/usr/bin/env node

const readline = require('readline');
const InputParser = require('../src/InputParser.js');
const MongoConnector = require('../src/MongoConnector.js');
const assert = require('assert');

const rl = readline.createInterface({
    input: process.stdin,
    output: process.stdout
});

const parser = new InputParser();
const connector = new MongoConnector();

rl.on('line', (line) => {
    let trimmed = line.trim();
    switch (trimmed) {
        case 'q':
        case 'quit':
            console.log(`Ok. Goodbye!`);
            connector.close();
            rl.close();
            break;

        default:
            // parse purchase
            let result = parser.parse(trimmed);
            console.log(`${trimmed} parsed`, result);

            // save result object to mongo
            (async function() {
                try {
                    let db = await connector.connect();
                    let col = db.collection('purchases');
                    let r = await col.insertOne(result);
                    console.log(r.ops);
                    console.log(`${trimmed} saved with _id ${r.ops._id}!`);
                } catch (e) {
                    console.log(e.stack);
                }
            })();
            break;
    }
    rl.prompt();
});

console.log('Purchase input. Input `q` or `quit` when done');
